<!-- ====== Version 0.5.2 Jul. 31th 09:04 ====== -->

<!DOCTYPE html>
<html>
<head>
	<title>
		logReader
	</title>

<!-- =============== Table Style Design ================= -->

<style type="text/css">
table{
	border-collapse   :  collapse;
}

table, td{
	border            :  1px solid silver;
}
thead{
	display           :  block;
}
tbody{
	display           :  block;
    height            :  880px;
    overflow-y        :  auto;
    overflow-x        :  auto;
}
.divcss1{
	background-color  :  orange;
	height            :  50px;
	width             :  500px;
}

.divcss2{
	width             :  500px;  
	height            :  880px;
	text-align        :  left;
    vertical-align    :  top;
	padding           :  0;
	overflow-x        :  auto;
	overflow-y        :  auto;
}

</style>
</head>

<body>

<!-- =============== function: createTable ================= -->

<script>
function createTable(files){
	var table = document.createElement("table"); 
	table.setAttribute("id","table"); 
    var thead = document.createElement("thead"); 
    thead.setAttribute("id","thead");
    var tr = document.createElement("tr"); 
       
    for (var i = 0; i < files.length; i++) { 
        var th = document.createElement("th"); 

        th.setAttribute("id",i);
        th.setAttribute("class","divcss1");
        tr.appendChild(th); 
    } 


    thead.appendChild(tr); 
    table.appendChild(thead); 
    
    var tbody = document.createElement("tbody"); 
    for (var i = 0; i < 1; i++) { 
        var tr = document.createElement("tr"); 
        for (var j=0; j < files.length; j++) { 
            var td = document.createElement("td");
    		
            td.setAttribute("id",files.length + j);
            td.setAttribute("class","divcss2");
            tr.appendChild(td);   
        } 
        tbody.appendChild(tr); 
    }
    table.appendChild(tbody); 
    return table;
}
</script>

<!-- =============== function: transfer \n to </br> ================= -->

<script type="text/javascript">
function Br(content)  
	{  
    var string = content;  
    	try{  
       	 	string=string.replace(/\r\n/g,"<BR>")  
      		string=string.replace(/\n/g,"<BR>");  
    }catch(e){  
        //alert(e.message);
    }  
    	return string;  
}  
</script>


<!-- =============== main function ================= -->

<script type="text/javascript">
function printdoc(){
	var fs = require('fs');
	var path = process.env.HOME + '/.custard/servlog/';
	var bpath = process.env.HOME + '/.custard/tmp/';

	fs.readdir(path, function(err,files){ 
		if(err){ 
			document.write("error:\n"+err); 
			return; 
		}
		var table = createTable(files); 
       	document.body.appendChild(table);
       	document.getElementById("table").width = files.length * 500 + 'px' ;

		function gencb(filename, id){		

			//initial the screen

			var readstream = fs.createReadStream(path + filename);
			fs.createReadStream(path + filename).pipe(fs.createWriteStream(bpath + '.' + filename)); 

			readstream.on ('data',function(data){
		    fs.stat(path + filename,function(err, stats){     
		            document.getElementById(id).innerHTML = Br( "\n" + data) ;
		        });
		    });

			//copy the log file to tmp file as realtime

		    fs.watchFile(path + filename, function (curr, prev) {
		    	if(prev.size > curr.size){
		    		var readstream = fs.createReadStream(path + filename);
			        readstream.on ('data',function(data1){
			            fs.appendFile(bpath + '.' + filename, ("===== "  + curr.mtime + "=====" + '\n' + data1 + '\n'), function (err) {   //if the log has been cleaned, reread it
		  					if (err) throw err;
						});
					});
		    	}
		    	else{
		        	var readstream = fs.createReadStream(path + filename,{ start : prev.size - 1 , end : curr.size });
			        readstream.on ('data',function(data1){
			            fs.appendFile(bpath + '.' + filename, ("===== "  + curr.mtime + "=====" + '\n' + data1 + '\n'), function (err) {   //else append the new line to the tmp file
		  					if (err) throw err;
						});
					});
				}
		    });

		    //print the tmp file onto the screen as realtime 

		    fs.watchFile(bpath + '.' + filename, function (curr, prev) {
				var readstream = fs.createReadStream(bpath + '.' + filename);
		        readstream.on ('data',function(data){
		        	document.getElementById(id).innerHTML = Br('\n' + data + '\n');
		        });
		   	});		    
		};

		//print the table head

		for( var i = 0;i < files.length ; i++){
			document.getElementById(i).innerHTML = files[i];
		}

		//execute the print module

		for( var i = 0;i < files.length  ;i++){
			//console.log(path + files[i]);
	    	gencb(files[i] , i + files.length);   	
		}		
	});

	//remove the tmp file when closing the browser
	
	window.onunload = function (){
		rmdoc();
	}
}

/* ================= function: remove the tmp file =================== */

function rmdoc(){
	var fs = require('fs');
	var bpath = process.env.HOME + '/.custard/tmp/';
	fs.readdir(bpath, function(err,files){ 
		if(err) throw err;
		for( var i = 0;i < files.length  ;i++){
			fs.unlink(bpath + files[i], function (err) {
				if(err) throw err;
			});
		}
	});	
}


window.onload = function() { 
    printdoc();
}


</script>
</body>
</html>