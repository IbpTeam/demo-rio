var events = require('events');
var util = require('util');
var mime = require('mime');
var netcomm = require('/home/cos/Templates/demo-rio/nodewebkit/backend/apiLocalHandle.js');

//eval(fs.readFileSync('./backend/apiHttpHandle.js')+'');

// Template engine
function gen_files_view(files){
    var result = [];
    for(var i=0; i<files.length; i++){
        result.push('<div class="file" data-path="' + files[i].path + '">');
        result.push('<div class="icon"> <img src="icons/' + files[i].type + '.png"></div>');
        result.push('<div class="name">' + files[i].name + '</div>');
        result.push('</div>');
    }
    return result.join('\n');
}
// Our type
function Folder(jquery_element, sidebar) {
	events.EventEmitter.call(this);
	this.element = jquery_element;
    this.side_bar = sidebar;
	var self = this;
	// Click on blank
	this.element.parent().on('click', function() {
		self.element.children('.focus').removeClass('focus');
	});
	// Click on file
	this.element.delegate('.file', 'click', function(e) {
		self.element.children('.focus').removeClass('focus');
		$(this).addClass('focus');
		e.stopPropagation();
	});
	// Double click on file
	this.element.delegate('.file', 'dblclick', function() {
	    var file_json = self.find_json_by_path($(this).attr('data-path'));
	    var file_path = file_json.path;
	    //console.log('file_json:', file_json);
	    if(file_json){
            var children = self.side_bar.children('li');
            for(var i=0; i<children.length; i++){
                child = $(children[i]);
                //console.log('child length',child.attr('data-path'), file_path);            
                if(child.attr('data-path') == file_path){
                    //console.log("match match");
                    self.side_bar.children('.active').removeClass('active');
                    self.side_bar.find('.icon-white').removeClass('icon-white');
                    child.addClass('active');
                    child.children('a').children('i').addClass('icon-white ');
                    break;
                }
            }
		    self.emit('navigate', file_json);//mime.stat(file_path, file_type)
		}
	});
}

util.inherits(Folder, events.EventEmitter);

var global_self;
var global_dir;
var file_arch_json = {};
Folder.prototype.gen_side_bar = function(root_json){
    var result = [];
    result.push('<li class="nav-header">Favorites</li>');
	result.push('<li data-path="root" class="active"><a href="#"><i class="icon-white icon-home"></i> Root</a></li>');
    for(var i=0; i< root_json.length; i++){
        var str='<li data-path="'+root_json[i].path+'"><a href="#"><i class="';
        switch(root_json[i].name)
        {
            case 'Contacts':
                str+='icon-book';
                break;
            case 'Pictures':
                str+='icon-picture';
                break;
            case 'Videos':
                str+='icon-film';
                break;
        }
        str+='"></i> '+root_json[i].name+'</a></li>';
	    result.push(str);
	}
	result.push('<li class="divider"></li>');
	result.push('<li data-path="about"><a href="#"><i class="icon-flag"></i> About</a></li>');
    global_self.side_bar.html(result.join('\n'));
	global_self.side_bar.delegate('a', 'click', function() {
		global_self.side_bar.children('.active').removeClass('active');
		global_self.side_bar.find('.icon-white').removeClass('icon-white');
		$(this).parent().addClass('active');
		$(this).children('i').addClass('icon-white ');
		var file_path = $(this).parent().attr('data-path');		
	    //var file_json = global_self.find_json_by_path(file_path);
	    //console.log('click on side_bar', file_json);
	    //if(file_json){
		    //global_self.emit('navigate', file_json);
		//}
		if('about' == file_path){
		    window.alert('in developing...^_^');
		}else{
            global_self.open(file_path);
            global_self.emit('set_address', file_path);
        }
	});
}
Folder.prototype.find_json_by_path = function(filepath){
    var all = file_arch_json[global_dir];
    //console.log('global_dir', global_dir);
    //console.log('filepath', filepath);
    //console.log('file_arch_json[global_dir]', file_arch_json[global_dir]);
    var file = false;
    for(var i=0; i<all.length; i++){
        if(all[i].path == filepath){
            file = all[i];
            break;
        }
    }
    return file;
}
Folder.prototype.get_callback_data = function(data_json){
	//console.log('data from server:', data_json);
	switch(global_dir){
	case 'root':
	    for(var i=0; i<data_json.length; i++){
	        data_json[i]['path'] = 'root/'+data_json[i]['type'];
	        data_json[i]['name'] = data_json[i]['type'];
	        data_json[i]['type'] = 'folder';	    
	    }
	    global_self.gen_side_bar(data_json);
	    break;
    case 'root/Contacts':
	    for(var i=0; i<data_json.length; i++){
	        data_json[i]['path'] = 'root/Contacts/'+data_json[i]['name'];
	        //data_json[i]['img'] = '.'+data_json[i]['photoPath'];	        
	        data_json[i]['type'] = 'image';
	    }
        break;
    case 'root/Pictures':
	    for(var i=0; i<data_json.length; i++){
	        data_json[i]['path'] = 'root/Pictures/'+data_json[i]['filename'];
	        data_json[i]['name'] = data_json[i]['filename'];
	        //data_json[i]['img'] = '.'+data_json[i]['photoPath'];	        
	        data_json[i]['type'] = 'text';
	    }
        break;
    case 'root/Videos':
	    for(var i=0; i<data_json.length; i++){
	        data_json[i]['path'] = 'root/Videos/'+data_json[i]['filename'];
	        data_json[i]['name'] = data_json[i]['filename'];
	        //data_json[i]['img'] = '.'+data_json[i]['photoPath'];	        
	        data_json[i]['type'] = 'movie';
	    }
        break;
    default:
        break;
	}
	file_arch_json[global_dir] = data_json;
	//console.log('data from server after treat:', data_json);
	global_self.element.html(gen_files_view(data_json));
}


Folder.prototype.open = function(dir) {
	global_self = this;
	global_dir = dir;
	switch(global_dir){
	case 'root':
	    netcomm.getAllCateFromLocal(this.get_callback_data);
	    break;
    case 'root/Contacts':
        netcomm.getAllContactsFromLocal(this.get_callback_data);
        break;
    case 'root/Pictures':
        netcomm.getAllDataByCateFromLocal(this.get_callback_data, 'Pictures');
        break;
    case 'root/Videos':
        netcomm.getAllDataByCateFromLocal(this.get_callback_data, 'Videos');
        break;
    default:
        window.alert('Path '+global_dir+' does not exist.');
        break;
	}
}

exports.Folder = Folder;
//data from server:
//root:
//[{"id":"0#101","type":"Contacts","path":"./resources/logo/contacts.png"},{"id":"0#102","type":"Pictures","path":"./resources/logo/pictures.png"},{"id":"0#103","type":"Videos","path":"./resources/logo/videos.png"}]
//Contact:
//[{"id":"1#1","name":"Lily","photoPath":"./resources/contacts/boy.jpg"},{"id":"1#2","name":"zhang","photoPath":"./resources/contacts/city3.jpg"},{"id":"1#3","name":"wang","photoPath":"./resources/contacts/girl1.jpg"},{"id":"1#4","name":"li","photoPath":"./resources/contacts/girl2.jpg"},{"id":"1#5","name":"zhao","photoPath":"./resources/contacts/girl3.jpg"},{"id":"1#13","name":"zhang","photoPath":"./resource/photo/test.jpg"},{"id":"1#1000014","name":"zhang","photoPath":"./resource/photo/test.jpg"}]
//Pictures
// [{"id":"2#1","filename":"jianmin","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/contactsphoto/jianmin.jpg"},{"id":"2#2","filename":"wangyu","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/contactsphoto/wangyu.jpg"},{"id":"2#3","filename":"xifei","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/contactsphoto/xifei.jpg"},{"id":"2#4","filename":"yuanzhe","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/contactsphoto/yuanzhe.jpg"},{"id":"2#5","filename":"contacts","postfix":"png","path":"/home/v1/demo-rio/nodewebkit/resources/logo/contacts.png"},{"id":"2#6","filename":"pictures","postfix":"png","path":"/home/v1/demo-rio/nodewebkit/resources/logo/pictures.png"},{"id":"2#7","filename":"city1","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/city1.jpg"},{"id":"2#8","filename":"city4","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/city4.jpg"},{"id":"2#9","filename":"city3","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/city3.jpg"},{"id":"2#10","filename":"city2","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/city2.jpg"},{"id":"2#11","filename":"girl2","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/girl2.jpg"},{"id":"2#12","filename":"girl3","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/girl3.jpg"},{"id":"2#13","filename":"vessel1","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/vessel1.jpg"},{"id":"2#14","filename":"Penguins","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/Penguins.jpg"},{"id":"2#15","filename":"city5","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/city5.jpg"},{"id":"2#16","filename":"wangtan","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/contactsphoto/wangtan.jpg"},{"id":"2#17","filename":"wuxiang","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/contactsphoto/wuxiang.jpg"},{"id":"2#18","filename":"boy","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/boy.jpg"},{"id":"2#19","filename":"cat","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/cat.jpg"},{"id":"2#20","filename":"videos","postfix":"png","path":"/home/v1/demo-rio/nodewebkit/resources/logo/videos.png"},{"id":"2#21","filename":"vessel2","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/vessel2.jpg"},{"id":"2#22","filename":"wangfeng","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/contactsphoto/wangfeng.jpg"},{"id":"2#23","filename":"girl1","postfix":"jpg","path":"/home/v1/demo-rio/nodewebkit/resources/pictures/girl1.jpg"}]
//Videos
//[{"id":"3#1","filename":null,"postfix":"flv","path":"./resources/videos/test1.flv"},{"id":"3#2","filename":null,"postfix":"flv","path":"./resources/videos/test2.flv"},{"id":"3#3","filename":null,"postfix":"flv","path":"./resources/videos/test3.flv"},{"id":"3#4","filename":null,"postfix":"hlv","path":"./resources/videos/test4.hlv"},{"id":"3#10000005","filename":null,"postfix":"hlv","path":"./resources/videos/test5.hlv"}]
/*
	files = [
			{
				"name" : "bootstrap",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/bootstrap",
				"type" : "folder"
			},
			{
				"name" : "bundle.js",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/bundle.js",
				"type" : "blank"
			},
			{
				"name" : "icons",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/icons",
				"type" : "folder"
			},
			{
				"name" : "images",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/images",
				"type" : "folder"
			},
			{
				"name" : "index.html",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/index.html",
				"type" : "html"
			},
			{
				"name" : "js",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/js",
				"type" : "folder"
			},
			{
				"name" : "main.js",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/main.js",
				"type" : "blank"
			},
			{
				"name" : "node_modules",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/node_modules",
				"type" : "folder"
			},
			{
				"name" : "package.json",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/package.json",
				"type" : "blank"
			},
			{
				"name" : "README.md",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/README.md",
				"type" : "text"
			},
			{
				"name" : "style.css",
				"path" : "/home/cos/Templates/node-webkit-v0.9.2-linux-ia32_and_example/file-explorer/style.css",
				"type" : "css"
			} ];
*/
