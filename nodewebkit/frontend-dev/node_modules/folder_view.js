//var events = require('events');
//var util = require('util');

//var fs = require('fs');
//eval(fs.readFileSync('../backend/api.js')+'');

var frontend_local = 'Nodejs';
function browser(){
    var ua = window.navigator.userAgent, ret = "";
    console.log('ua', ua);
    if(/Nodejs/g.test(ua)){
        ua = ua.split(" ");
        ret = frontend_local + "|"+ua[ua.length-1].split("/")[1];
    }
    else if(/Firefox/g.test(ua)){
        ua = ua.split(" ");
        ret="Firefox|"+ua[ua.length-1].split("/")[1];
    }
    else if(/MSIE/g.test(ua)){
        ua = ua.split(";");
        ret = "IE|"+ua[1].split(" ")[2];
    }
    else if(/Opera/g.test(ua)){
        ua = ua.split(" ");
        ret = "Opera|"+ua[ua.length-1].split("/")[1];
    }
    else if(/Chrome/g.test(ua)){
        ua = ua.split(" ");
        ret = "Chrome|"+ua[ua.length-2].split("/")[1];
    }
    else if(/^apple\s+/i.test(window.navigator.vendor)){
        ua = ua.split(" ");
        ret = "Safair|"+ua[ua.length-2].split("/")[1];
    }
    else{
        ret = "未知浏览器";
    }
    console.log('ret', ret);
    return ret.split("|");
}
var r = browser();
var frontend_type = r[0];
//var ip='192.168.160.176';
var ip = '127.0.0.1';
var port = ':8888';
// Template engine
function gen_files_view(files){
    var results = [];
    for(var i=0; i<files.length; i++){
		var file = files[i];
        results.push('<div class="file" data-path="' + file['props'].path + '">');
        if(file['props'].img){
            if(frontend_type == frontend_local){ 
                results.push('<div class="icon"> <img src="' + file['props'].img + '"></div>');
            }else{
                results.push('<div class="icon"> <img src="' + file['props'].img + '?query=absolute"></div>');
            }
        }else{
            results.push('<div class="icon"> <img src="icons/' + file['props'].icon + '.png"></div>');
        }
        results.push('<div class="name">' + file['props'].name + '</div>');
        results.push('</div>');
    }
    return results.join('\n');
}

function gen_view_table(files){
    function get_json_key(data_json){
        var keys = [];
        for(var key in data_json){
            if(key == 'props')
                continue;
            keys.push(key);
        }
        return keys;
    }
    function gen_body_tr(data_json, keys){
	    var tr = $('<tr></tr>');
	    for(var i=0; i<keys.length; i++){
	        tr.append($('<th>' + data_json[keys[i]] + '</th>'))
	    }
	    return tr;
	}
	
    var keys = get_json_key(files[0]);
    //console.log('keys', keys);
    
    var thead = $('<thead></thead>');
	var tr = $('<tr></tr>');
	for(var i=0; i<keys.length; i++){
	    tr.append($('<th>' + keys[i] + '</th>'))
	}
	tr.addClass('success');
	thead.append(tr);
	    
    var tbody = $('<tbody></tbody>');
    for(var i=0; i<files.length; i++){
		tbody.append(gen_body_tr(files[i], keys));
	}
	    
	var table = $('<table></table>');
	table.append(thead);
	table.append(tbody);
	table.addClass('table');
	
    var div = $('<div></div>');
    div.addClass('panel panel-primary');
    div.append(table);
    
    return div;
/*
<div class="panel panel-primary">
      <table class="table">
        <thead>
          <tr class='success'>
            <th>#</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Username</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>Mark</td>
            <td>Otto</td>
            <td>@mdo</td>
          </tr>
          <tr>
            <td>2</td>
            <td>Jacob</td>
            <td>Thornton</td>
            <td>@fat</td>
          </tr>
          <tr>
            <td>3</td>
            <td>Larry</td>
            <td>the Bird</td>
            <td>@twitter</td>
          </tr>
        </tbody>
      </table>
</div>
*/
}
function gen_popup_dialog(title, message){
    $("#popup_dialog").remove();

    var header_btn = $('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>');
    var header_title = $('<h4 class="modal-title"></h4>');
    header_title.text(title);
    var header = $('<div class="modal-header"></div>');
    header.append(header_btn).append(header_title);
    
    var body = $('<div class="modal-body"></div>');
    body.html(message);
    
    var footer = $('<div class="modal-footer"></div>');
    var footer_btn = $('<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>');
    footer.append(footer_btn);
    
    var content = $('<div class="modal-content"></div>');
    content.append(header);
    content.append(body);
    content.append(footer);
    
    var dialog = $('<div class="modal-dialog"></div>');
    dialog.append(content);
    var div = $('<div id="popup_dialog" class="modal fade"></div>');
    div.append(dialog);
    $('body').append(div);
    $("#popup_dialog").modal('show');
}
function cb_get_data_source_file(data_json){
    console.log('get data source file', data_json);
    if(!data_json['openmethod'] || !data_json['content']){
        window.alert('openmethod or content not found.');
        return false;
    }
    var method = data_json['openmethod'];
    var content = data_json['content'];
    
//    var pos = content.lastIndexOf(".");
//    var suffix = '';
//    if(pos != -1){
//        suffix = content.substr(pos+1).toLowerCase();
//    }
    
    var path, arg, pos, suffix = '', results_arr = []; 
    switch(method){
    case 'direct':
        //http://localhost:8888/home/v1/demo-resources/contactsphoto/jianmin.jpg?query=absolute
        if(/http:\/\/([^\?]*)\?(.*)/.test(content)){
            results_arr = content.replace(/http:\/\/([^\?]*)\?(.*)/, '$1\n$2').split('\n');
            path = results_arr[0];
            //arg =  results_arr[1];
            pos = path.lastIndexOf(".");
            if(pos != -1){
                suffix = path.substr(pos+1).toLowerCase();
            }
        }
        //{"openmethod":"direct","content":"/home/cos/Templates/resources/contactsphoto/wangfeng.jpg"}
        else
        {
            path = content;
            pos = path.lastIndexOf(".");
            if(pos != -1){
                suffix = path.substr(pos+1).toLowerCase();
            }
        }
        break;
    default:
        break;
    }
    
    var file_content ='';
    switch(method){
    case 'direct':
        switch(suffix){
        case 'jpg':
            file_content = '<img src=' + content + '>';
            break;
        case 'txt':
            //var data = '';
            file_content = $("<p></p>").load(content);
            //console.log('*****************file_content', data);
//            if(frontend_type == frontend_local){ 
//                results.push('<div class="icon"> <img src="' + file['props'].img + '"></div>');
//            }else{
//                results.push('<div class="icon"> <img src="' + file['props'].img + '?query=absolute"></div>');
//            }
            break;
        case 'ogg':
            file_content = $('<audio controls></audio>');
            file_content.html('<source src=' + content + ' type="audio/mpeg">');
            //"http://localhost:8888/home/v1/resources/musics/whoyouare.mp3?query=absolute"
            break;
        default:
            window.alert('suffix is not recognized.');
            break;
        }
        gen_popup_dialog('文件浏览', file_content);
    break;
    case 'local':
        //break;
    case 'remote':
        window.alert('需要试用noVNC打开' + '\nopenmethod:'+method+'\ncontent:'+content);
        break;
    }
    //{"openmethod":"local","content":"/home/cos/Templates/resources/documents/preseed\u5B9E\u73B0livecd\u81EA\u52A8\u5B89\u88C5.docx"}
}
function cb_get_all_data_file(data_json){
    console.log('get all data file', data_json);
    var file_propery='';
    for(var key in data_json){
        file_propery += '<p>' + key + ': ' + data_json[key] + '</p>';
    }
    gen_popup_dialog('属性', file_propery);
}
// Our type
function Folder(jquery_element) {
    //events.EventEmitter.call(this);
    this.element = jquery_element;
    var self = this;
    this.element.parent().on('mousedown', function(e) {
        switch(e.which){
        case 3:
            var contents = ['创建文件夹', '创建文档', '排列项目', '属性'];
            //var contents = ['aaa', 'bbb', 'ccc', 'ddd'];
            var popup_menu = self.gen_popup_menu(contents);            
            var row = this;
            $(popup_menu).on('mouseup', function(e){
                console.log('right button for ', global_dir);
                for(var i=0; i<contents.length; i++){
                    if($(e.target).text() == contents[i]){
                        console.log('folder_view pop_menu ' + contents[i] + 'is clicked');
                    }                
                }
                $(this).remove();
                self.element.children('.focus').removeClass('focus');
                e.stopPropagation();  
            });
            self.element.append(popup_menu);  
            self.element.children('.dropdown-menu').css({
                'display':'block',
                'position': 'fixed',
                'left': (e.pageX) + 'px',
                'top': (e.pageY) + 'px'
            });
            break;
        case 1:
            self.element.children('.focus').removeClass('focus');
            self.element.children('.dropdown-menu').css({'display':'none'});
            break;
        }
        //e.stopPropagation();
    });
    
    this.element.delegate('.file', 'mousedown', function(e) {
        self.element.children('.focus').removeClass('focus');
        $(this).addClass('focus');
        switch(e.which){
        case 3:
            var contents = ['打开', '属性'];// '编辑', '删除',
            var popup_menu = self.gen_popup_menu(contents);
            var dst_file = this;
            $(popup_menu).on('mouseup', function(e){
//                for(var i=0; i<contents.length; i++){
//                    if($(e.target).text() == contents[i]){
//                        //console.log('destination file: '+ $(dst_file).attr('data-path') + ' pop_menu ' + contents[i] + 'is clicked');
//                    }                
//                }
                var file_json = self.find_json_by_path($(dst_file).attr('data-path'));
                if(!file_json){
                    window.alert('data-json was not found.');
                    return false;
                }
                switch($(e.target).text()){
                case '打开':
                    switch(file_json['props']['type']){
                    case 'folder':
                        self.emit('navigate', file_json);
                        break;
                    case 'file':
                        getDataSourceById(cb_get_data_source_file, file_json.id);
                        break;
                    }
                    break;
                case '属性':
                    switch(file_json['props']['type']){
                    case 'folder':
                        var data_json = file_json['props'];
                        var file_propery='';
                        for(var key in data_json){
                            file_propery += '<p>' + key + ': ' + data_json[key] + '</p>';
                        }
                        gen_popup_dialog('属性', file_propery);
                        break;
                    case 'file':
                        //console.log('id: ', file_json.id);
                        getDataById(cb_get_all_data_file, file_json.id);
                        break;
                    }
                    break;
                }
                $(this).remove();
                self.element.children('.focus').removeClass('focus');
                e.stopPropagation();  
            });

            self.element.append(popup_menu);
            self.element.children('.dropdown-menu').css({
                'display':'block',
                'position': 'fixed',
                'left': (e.pageX) + 'px',
                'top': (e.pageY) + 'px'
            });
            break;
        case 1:
            self.element.children('.dropdown-menu').css({'display':'none'});
            break;
        }
        e.stopPropagation();
    });
    // Double click on file
    this.element.delegate('.file', 'dblclick', function() {
        //var file_json = self.find_json_by_path($(this).attr('data-path'));        
        var file_json = self.find_json_by_path($(this).attr('data-path'));
        if(!file_json){
            window.alert('data-json was not found.');
            return false;
        }
        switch(file_json['props']['type']){
        case 'folder':
            self.emit('navigate', file_json);
            break;
        case 'file':
            getDataSourceById(cb_get_data_source_file, file_json.id);
            break;
        }
    });    
        
    $('#div-setting').css('background', 'none');
//    function change_value(){
//        console.log($("#div-setting #liststyle").slider("value"));
//    }
    $("#div-setting #liststyle").slider({
        orientation: "horizontal",
        min: 0,
        max: 30,
        range: "min",
        value:15,
        change: self.show_folder_view,
    });
}
//util.inherits(Folder, events.EventEmitter);


Folder.prototype.gen_popup_menu = function(contents){
    this.element.children('.dropdown-menu').remove();
    var menu = $('<ul></ul>');
    $(menu).attr({
        'class':'dropdown-menu',
        'role':'menu',
        'aria-labelledby': 'dropdownMenu'
    });
    var items = [];
    for(var i=0; i<contents.length; i++){
        items.push('<li><a tabindex="-1" href="#">' + contents[i] + '</a></li>');
    }
    $(menu).html(items.join('\n'));
    
            $(menu).on('mousedown', function(e){
                e.stopPropagation();  
            });

    //<li class="divider"></li>
    return menu;
}
var global_self;
var global_dir;
var file_arch_json = {};
Folder.prototype.find_json_by_path = function(filepath){
    var all = file_arch_json[global_dir];
    //console.log('global_dir', global_dir);
    //console.log('filepath', filepath);
    //console.log('file_arch_json[global_dir]', file_arch_json[global_dir]);
    var file = false;
    if(all.length){
        for(var i=0; i<all.length; i++){
            if(all[i]['props'].path == filepath){
                file = all[i];
                break;
            }
        }
    }
    return file;
}
Folder.prototype.get_callback_data = function(data_json){
    console.log('data from server:', data_json);
    switch(global_dir){
    case 'root':
        for(var i=0; i<data_json.length; i++){
            data_json[i]['props'] = {};
            data_json[i]['props']['path'] = 'root/'+data_json[i]['type'];
            data_json[i]['props']['name'] = data_json[i]['type'];
            data_json[i]['props']['type'] = 'folder';
            data_json[i]['props']['icon'] = 'folder';
        }        
	    //console.log('set favorites1.', data_json);
        global_self.emit('set_favorites', data_json);
        break;
    case 'root/Contacts':
        for(var i=0; i<data_json.length; i++){
            data_json[i]['props'] = {};
            //data_json[i]['img'] = data_json[i]['photoPath'];
            data_json[i]['props']['path'] = 'root/Contacts/'+data_json[i]['name'];
            data_json[i]['props']['name'] = data_json[i]['name'];
            data_json[i]['props']['type'] = 'file';
            data_json[i]['props']['icon'] = 'Contacts';
        }
        break;
    case 'root/Pictures':
        for(var i=0; i<data_json.length; i++){
            data_json[i]['props'] = {};
            data_json[i]['props']['img'] = data_json[i]['path'];
            data_json[i]['props']['path'] = 'root/Pictures/'+data_json[i]['filename'];
            data_json[i]['props']['name'] = data_json[i]['filename'];      
            data_json[i]['props']['type'] = 'file';
            data_json[i]['props']['icon'] = 'Pictures';
        }
        break;
     case 'root/Videos':
        for(var i=0; i<data_json.length; i++){
            data_json[i]['props'] = {};
            data_json[i]['props']['path'] = 'root/Videos/'+data_json[i]['filename'];
            data_json[i]['props']['name'] = data_json[i]['filename'];
            //data_json[i]['img'] = '.'+data_json[i]['photoPath'];            
            data_json[i]['props']['type'] = 'file';
            data_json[i]['props']['icon'] = 'Videos';
        }
        break;
    case 'root/Documents':
        for(var i=0; i<data_json.length; i++){
            data_json[i]['props'] = {};
            //data_json[i]['img'] = '.'+data_json[i]['photoPath'];         
            data_json[i]['props']['path'] = 'root/Documents/'+data_json[i]['filename'];
            data_json[i]['props']['name'] = data_json[i]['filename'];   
            data_json[i]['props']['type'] = 'file';
            data_json[i]['props']['icon'] = 'Documents';
        }
        break;
    case 'root/Music':
        for(var i=0; i<data_json.length; i++){
            data_json[i]['props'] = {};
            data_json[i]['props']['path'] = 'root/Music/'+data_json[i]['filename'];
            data_json[i]['props']['name'] = data_json[i]['filename'];
            //data_json[i]['img'] = '.'+data_json[i]['photoPath'];            
            data_json[i]['props']['type'] = 'file';
            data_json[i]['props']['icon'] = 'Music';
        }
        break;
    default:
        break;
    }
    global_self.emit('set_sidebar', data_json);
    file_arch_json[global_dir] = data_json;
    //console.log('data from server after treat:', data_json);
    global_self.show_folder_view(global_dir);
}
Folder.prototype.show_folder_view = function() {
    //console.log('in show folder view, global dir:', get_settings('liststyle'));
    data_json = file_arch_json[global_dir];
    global_self.element.children().remove();

    switch(get_settings('liststyle')){
        case 0:
            global_self.element.append(gen_view_table(data_json));
            break;
        case 1:
            global_self.element.html(gen_files_view(data_json));
            break;
        default:
            global_self.element.html(gen_files_view(data_json));
            break;
    }
}

function get_settings(set){
    switch(set){
    case 'liststyle':
        var liststyle = $("#div-setting #liststyle").slider("value") / 10;
        liststyle = parseInt(liststyle);
        return liststyle;
        //break;
    }
}

Folder.prototype.open = function(dir) {
    global_self = this;
    global_dir = dir;
    console.log('global_dir', global_dir);
    switch(global_dir){
    case 'root':
        getAllCate(this.get_callback_data);
        //getAllCateFromHttp(this.get_callback_data);
        break;
    case 'root/Contacts':
        getAllDataByCate(this.get_callback_data, 'Contacts');
        //getAllContactsFromHttp(this.get_callback_data);
        break;
    case 'root/Pictures':
        getAllDataByCate(this.get_callback_data, 'Pictures');
        //getAllDataByCateFromHttp(this.get_callback_data, 'Pictures');
        break;
    case 'root/Videos':
        getAllDataByCate(this.get_callback_data, 'Videos');
        //getAllDataByCateFromHttp(this.get_callback_data, 'Videos');
        break;
    case 'root/Documents':
        getAllDataByCate(this.get_callback_data, 'Documents');
        //getAllDataByCateFromHttp(this.get_callback_data, 'Documents');
        break;
    case 'root/Music':
        getAllDataByCate(this.get_callback_data, 'Music');
        //getAllDataByCateFromHttp(this.get_callback_data, 'Music');
        break;
    default:
        window.alert('Path ' + global_dir + ' does not exist.');
        break;
    }
}


$.extend(Folder.prototype, $.eventEmitter);
//exports.Folder = Folder;

